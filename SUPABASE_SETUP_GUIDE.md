# دليل ربط موقع "ترليون" بقاعدة بيانات Supabase

## المحتويات

1. [مقدمة](#مقدمة)
2. [إنشاء مشروع Supabase](#إنشاء-مشروع-supabase)
3. [إعداد قاعدة البيانات](#إعداد-قاعدة-البيانات)
4. [ربط المشروع بالموقع](#ربط-المشروع-بالموقع)
5. [تشغيل المشروع](#تشغيل-المشروع)
6. [الأسئلة الشائعة](#الأسئلة-الشائعة)

---

## مقدمة

يهدف هذا الدليل إلى مساعدتك في ربط موقع "ترليون" بقاعدة بيانات Supabase الحقيقية بدلاً من الوضع التجريبي المحلي. بعد اتباع هذا الدليل، سيتم حفظ جميع حسابات المستخدمين والمنتجات والطلبات والأخبار في قاعدة البيانات السحابية.

---

## إنشاء مشروع Supabase

### الخطوة الأولى: إنشاء حساب

1. اذهب إلى موقع [Supabase](https://supabase.com) وانقر على "Start your project" أو "Sign Up".
2. يمكنك التسجيل باستخدام البريد الإلكتروني أو حساب GitHub.
3. بعد التسجيل، انقر على "New Project" لإنشاء مشروع جديد.

### الخطوة الثانية: إعدادات المشروع

عند إنشاء مشروع جديد، ستحتاج إلى إدخال المعلومات التالية:

| الحقل | الوصف |
|-------|-------|
| Name | اسم المشروع (مثل: trillion-store) |
| Database Password | كلمة مرور قاعدة البيانات (احفظها في مكان آمن) |
| Region | اختر أقرب منطقة لك (مثل: Asia Southeast - Singapore) |

### الخطوة الثالثة: الحصول على مفاتيح API

بعد إنشاء المشروع:

1. اذهب إلى **Settings** من القائمة الجانبية اليسرى.
2. انقر على **API**.
3. ستجد معلومات المشروع تحتوي على:
   - **Project URL**: رابط المشروع (شكله: `https://xxxxx.supabase.co`)
   - **anon public key**: المفتاح العام (يبدأ بـ `eyJ...`)

انسخ هذه القيم حيث ستحتاجها لاحقاً.

---

## إعداد قاعدة البيانات

### الخطوة الأولى: تشغيل SQL Schema

1. اذهب إلى **SQL Editor** من القائمة الجانبية.
2. انقر على **New query** لإنشاء استعلام جديد.
3. انسخ محتوى ملف `supabase-schema.sql` الموجود في مجلد المشروع.
4. الصق المحتوى في محرر SQL.
5. انقر على **Run** لتنفيذ الأوامر.

### الخطوة الثانية: التحقق من إنشاء الجداول

بعد تنفيذ SQL، تأكد من إنشاء الجداول التالية في قسم **Table Editor**:

- `users` - جدول المستخدمين
- `products` - جدول المنتجات
- `product_keys` - جدول مفاتيح المنتجات
- `orders` - جدول الطلبات
- `order_items` - جدول عناصر الطلب
- `news` - جدول الأخبار
- `wishlists` - جدول المفضلة
- `reviews` - جدول التقييمات
- `promo_codes` - جدول أكواد الخصم

### الخطوة الثالثة: إعداد Storage (اختياري)

لإدارة رفع الصور:

1. اذهب إلى **Storage** من القائمة الجانبية.
2. انقر على **New bucket**.
3. أدخل اسم الـ Bucket: `images`
4. اختر "Public bucket" لتمكين الوصول العام للصور.
5. انقر على **Create bucket**.

### الخطوة الرابعة: إعداد Auth (المصادقة)

1. اذهب إلى **Authentication** من القائمة الجانبية.
2. انقر على **Providers**.
3. تأكد من تفعيل "Email" إذا تريد تسجيل الدخول بالبريد وكلمة مرور.
4. (اختياري) فعل "Google" لتسجيل الدخول عبر Google.

---

## ربط المشروع بالموقع

### الخطوة الأولى: تحديث ملف البيئة

1. انسخ ملف `.env.example` إلى `.env.local`:
   ```bash
   cp .env.example .env.local
   ```

2. افتح ملف `.env.local` وأضف القيم التي حصلت عليها من Supabase:

   ```env
   VITE_SUPABASE_URL=https://your-project-id.supabase.co
   VITE_SUPABASE_ANON_KEY=your-anon-key-here
   ```

   استبدل القيم الفعلية:
   - `your-project-id` بمعرّف مشروعك
   - `your-anon-key-here` بالمفتاح العام

### الخطوة الثانية: تشغيل المشروع

بعد إعداد البيئة:

1. تثبيت المكتبات:
   ```bash
   npm install
   ```

2. تشغيل خادم التطوير:
   ```bash
   npm run dev
   ```

3. افتح المتصفح على `http://localhost:5173`

### الخطوة الثالثة: اختبار الاتصال

للتأكد من أن الاتصال يعمل:

1. حاول إنشاء حساب جديد.
2. إذا تم التسجيل بنجاح، اذهب إلى **Table Editor** في Supabase وابحث عن المستخدم في جدول `users`.
3. إذا وجدت المستخدم، يعني ذلك أن الاتصال يعمل بشكل صحيح.

---

## الأسئلة الشائعة

### س: ماذا يحدث إذا لم أضبط إعدادات Supabase؟

ج: يعمل المشروع حالياً في "الوضع التجريبي" حيث يحفظ البيانات في التخزين المحلي للمتصفح (LocalStorage). لن تفقد أي بيانات حالية، فقط لن تكون متزامنة بين الأجهزة.

### س: كيف أمنح صلاحيات تاجر للمستخدم؟

ج: في لوحة تحكم Supabase:

1. اذهب إلى **Table Editor** واختر جدول `users`.
2. ابحث عن المستخدم وحدد صفه.
3. عدّل حقل `role` من `customer` إلى `merchant`.
4. احفظ التغييرات.

### س: كيف أضيف منتجات جديدة؟

ج: يمكنك إضافة المنتجات بطريقتين:

**الطريقة الأولى: من لوحة التاجر في الموقع**
1. سجل دخولك كتاجر.
2. اذهب إلى لوحة التاجر.
3. أضف معلومات المنتج والصورة.

**الطريقة الثانية: مباشرة من Supabase**
1. اذهب إلى **Table Editor**.
2. اختر جدول `products`.
3. انقر على **Insert row**.
4. أضف بيانات المنتج.

### س: كيف أضيف مفاتيح للمنتجات الرقمية؟

ج: لكل منتج رقمي، تحتاج لإضافة المفاتيح في جدول `product_keys`:

1. اذهب إلى **Table Editor** واختر `product_keys`.
2. أضف صف جديد يحتوي على:
   - `product_id`: معرف المنتج
   - `key_value`: الكود الرقمي الفعلي
   - `status`: `available`

### س: هل يمكنني تفعيل تسجيل الدخول عبر Google؟

ج: نعم، لكن تحتاج لإعداد Google OAuth:

1. اذهب إلى [Google Cloud Console](https://console.cloud.google.com).
2. أنشئ مشروع جديد.
3. فعّل Google+ API.
4. أنشئ OAuth 2.0 Client ID.
5. أضف رابط الموقع إلى "Authorized redirect URIs".
6. انسخ Client ID و Client Secret.
7. في Supabase اذهب إلى **Authentication > Providers** وأدخل البيانات.

### س: كيف أستعيد كلمة المرور؟

ج: Currently the password reset feature needs to be implemented in the AuthForms component. You can add a "Forgot Password" link that calls `supabase.auth.resetPasswordForEmail(email)`.

---

## ملاحظات مهمة

1. **مفتاح الخدمة (Service Role Key)**: لا تستخدمه في الكود frontend لأنه يعطي صلاحيات管理员 كاملة. استخدمه فقط في الخادم أو Edge Functions.

2. **الأمان**: تم تفعيل Row Level Security (RLS) لحماية البيانات. لا يمكن للمستخدمين قراءة أو تعديل بيانات بعضهم البعض.

3. **النسخ الاحتياطي**: Supabase يأخذ نسخ احتياطية تلقائية للمشاريع المدفوعة. للمشاريع المجانية، يُنصح بتصدير البيانات بشكل دوري.

---

## الدعم الفني

إذا واجهت أي مشاكل:

1. تحقق من Console في المتصفح للأخطاء.
2. راجع [وثائق Supabase الرسمية](https://supabase.com/docs).
3. ابحث عن الحلول في [Supabase Community](https://github.com/supabase/supabase/discussions).
